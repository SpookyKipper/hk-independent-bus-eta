name: Build Cordova Android APK

on:
  push:
    branches:
      - cordova

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout main repo and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0  # fetch full history for checking commits in submodule

    - name: Check if submodule updated
      id: check_submodule
      run: |
        # Get previous commit SHA for submodule
        git fetch origin cordova
        # Get the list of commits in submodule between previous and current
        PREV_COMMIT=$(git rev-parse HEAD^)
        CURRENT_COMMIT=$(git rev-parse HEAD)
        echo "Prev commit: $PREV_COMMIT"
        echo "Current commit: $CURRENT_COMMIT"

        # Check if submodule folder changed between previous and current commit
        # We'll check for changes in submodule folder path, e.g., path/to/submodule
        SUBMODULE_PATH=$(git config -f .gitmodules submodule.*.path | head -1)
        echo "Submodule path: $SUBMODULE_PATH"

        # Check if any commits in the submodule changed
        if git diff $PREV_COMMIT $CURRENT_COMMIT -- $SUBMODULE_PATH | grep .; then
          echo "submodule_changed=true" >> $GITHUB_OUTPUT
        else
          echo "submodule_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Build APK if submodule changed
      if: steps.check_submodule.outputs.submodule_changed == 'true'
      run: |
        npm install
        npx cordova build android

    - name: Upload APK artifact
      if: steps.check_submodule.outputs.submodule_changed == 'true'
      uses: actions/upload-artifact@v3.1.2
      with:
        name: app-debug.apk
        path: platforms/android/app/build/outputs/apk/debug/app-debug.apk

